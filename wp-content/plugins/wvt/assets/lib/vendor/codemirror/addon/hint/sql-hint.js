!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror"),require("../../mode/sql/sql")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../../mode/sql/sql"],t):t(CodeMirror)}(function(t){"use strict";var r,e,n,o={QUERY_DIV:";",ALIAS_KEYWORD:"AS"},i=t.Pos;function s(t){return"string"==typeof t?t:t.text}function a(t,r){if(!t.slice)return t[r];for(var e=t.length-1;e>=0;e--)if(s(t[e])==r)return t[e]}function u(t){var r={};for(var e in t)t.hasOwnProperty(e)&&(r[e]=t[e]);return r}function f(t,r){var e=t.length,n=s(r).substr(0,e);return t.toUpperCase()===n.toUpperCase()}function c(t,r,e,n){for(var o in e)e.hasOwnProperty(o)&&(e.slice&&(o=e[o]),f(r,o)&&t.push(n(o)))}function l(t){for(var r=s(t).split("."),e=0;e<r.length;e++)r[e]="`"+r[e]+"`";var n=r.join(".");return"string"==typeof t?n:((t=u(t)).text=n,t)}function p(t,r){if(t)for(var e=/[,;]/g,n=t.split(" "),o=0;o<n.length;o++)r(n[o]?n[o].replace(e,""):"")}function g(t){return t.line+t.ch/Math.pow(10,6)}function d(t){return i(Math.floor(t),+t.toString().split(".").pop())}function h(t,e){for(var n=e.doc,s=n.getValue(),u=t.toUpperCase(),f="",c="",l=[],h={start:i(0,0),end:i(e.lastLine(),e.getLineHandle(e.lastLine()).length)},v=s.indexOf(o.QUERY_DIV);-1!=v;)l.push(n.posFromIndex(v)),v=s.indexOf(o.QUERY_DIV,v+1);l.unshift(i(0,0)),l.push(i(e.lastLine(),e.getLineHandle(e.lastLine()).text.length));for(var m=0,A=g(e.getCursor()),b=0;b<l.length;b++){var x=g(l[b]);if(A>m&&A<=x){h={start:d(m),end:d(x)};break}m=x}var y=n.getRange(h.start,h.end,!1);for(b=0;b<y.length;b++){if(p(y[b],function(t){var e=t.toUpperCase();e===u&&a(r,f)&&(c=f),e!==o.ALIAS_KEYWORD&&(f=t)}),c)break}return c}t.registerHelper("hint","sql",function(o,s){r=s&&s.tables||{};var f=s&&s.defaultTable,p=s&&s.disableKeywords;e=f&&a(r,f),n=n||function(r){var e=r.doc.modeOption;return"sql"===e&&(e="text/x-sql"),t.resolveMode(e).keywords}(o),f&&!e&&(e=h(f,o)),(e=e||[]).columns&&(e=e.columns);var g,d,v,m=o.getCursor(),A=[],b=o.getTokenAt(m);return b.end>m.ch&&(b.end=m.ch,b.string=b.string.slice(0,m.ch-b.start)),b.string.match(/^[.`\w@]\w*$/)?(v=b.string,g=b.start,d=b.end):(g=d=m.ch,v=""),"."==v.charAt(0)||"`"==v.charAt(0)?g=function(t,n,o,s){for(var f,p=!1,g=[],d=n.start,v=!0;v;)v="."==n.string.charAt(0),p=p||"`"==n.string.charAt(0),d=n.start,g.unshift(("."==(f=n.string).charAt(0)&&(f=f.substr(1)),f.replace(/`/g,""))),"."==(n=s.getTokenAt(i(t.line,n.start))).string&&(v=!0,n=s.getTokenAt(i(t.line,n.start)));var m=g.join(".");c(o,m,r,function(t){return p?l(t):t}),c(o,m,e,function(t){return p?l(t):t}),m=g.pop();var A=g.join("."),b=!1,x=A;if(!a(r,A)){var y=A;(A=h(A,s))!==y&&(b=!0)}var q=a(r,A);return q&&q.columns&&(q=q.columns),q&&c(o,m,q,function(t){var r=A;return 1==b&&(r=x),"string"==typeof t?t=r+"."+t:(t=u(t)).text=r+"."+t.text,p?l(t):t}),d}(m,b,A,o):(c(A,v,r,function(t){return t}),c(A,v,e,function(t){return t}),p||c(A,v,n,function(t){return t.toUpperCase()})),{list:A,from:i(m.line,g),to:i(m.line,d)}})});