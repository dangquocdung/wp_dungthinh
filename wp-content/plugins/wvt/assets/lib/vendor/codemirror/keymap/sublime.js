!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/edit/matchbrackets")):"function"==typeof define&&define.amd?define(["../lib/codemirror","../addon/search/searchcursor","../addon/edit/matchbrackets"],e):e(CodeMirror)}(function(e){"use strict";var t=e.keyMap.sublime={fallthrough:"default"},n=e.commands,r=e.Pos,o=e.keyMap.default==e.keyMap.macDefault,i=o?"Cmd-":"Ctrl-";function a(t,n){t.extendSelectionsBy(function(o){return t.display.shift||t.doc.extend||o.empty()?function(t,n,o){if(o<0&&0==n.ch)return t.clipPos(r(n.line-1));var i=t.getLine(n.line);if(o>0&&n.ch>=i.length)return t.clipPos(r(n.line+1,0));for(var a,l="start",s=n.ch,c=o<0?0:i.length,f=0;s!=c;s+=o,f++){var u=i.charAt(o<0?s-1:s),h="_"!=u&&e.isWordChar(u)?"w":"o";if("w"==h&&u.toUpperCase()==u&&(h="W"),"start"==l)"o"!=h&&(l="in",a=h);else if("in"==l&&a!=h){if("w"==a&&"W"==h&&o<0&&s--,"W"==a&&"w"==h&&o>0){a="w";continue}break}}return r(n.line,s)}(t.doc,o.head,n):n<0?o.from():o.to()})}n[t["Alt-Left"]="goSubwordLeft"]=function(e){a(e,-1)},n[t["Alt-Right"]="goSubwordRight"]=function(e){a(e,1)};var l=o?"Ctrl-Alt-":"Ctrl-";function s(e,t){e.operation(function(){for(var n=e.listSelections().length,o=[],i=-1,a=0;a<n;a++){var l=e.listSelections()[a].head;if(!(l.line<=i)){var s=r(l.line+(t?0:1),0);e.replaceRange("\n",s,null,"+insertLine"),e.indentLine(s.line,null,!0),o.push({head:s,anchor:s}),i=l.line+1}}e.setSelections(o)})}function c(t,n){for(var o=n.ch,i=o,a=t.getLine(n.line);o&&e.isWordChar(a.charAt(o-1));)--o;for(;i<a.length&&e.isWordChar(a.charAt(i));)++i;return{from:r(n.line,o),to:r(n.line,i),word:a.slice(o,i)}}n[t[l+"Up"]="scrollLineUp"]=function(e){var t=e.getScrollInfo();if(!e.somethingSelected()){var n=e.lineAtHeight(t.top+t.clientHeight,"local");e.getCursor().line>=n&&e.execCommand("goLineUp")}e.scrollTo(null,t.top-e.defaultTextHeight())},n[t[l+"Down"]="scrollLineDown"]=function(e){var t=e.getScrollInfo();if(!e.somethingSelected()){var n=e.lineAtHeight(t.top,"local")+1;e.getCursor().line<=n&&e.execCommand("goLineDown")}e.scrollTo(null,t.top+e.defaultTextHeight())},n[t["Shift-"+i+"L"]="splitSelectionByLine"]=function(e){for(var t=e.listSelections(),n=[],o=0;o<t.length;o++)for(var i=t[o].from(),a=t[o].to(),l=i.line;l<=a.line;++l)a.line>i.line&&l==a.line&&0==a.ch||n.push({anchor:l==i.line?i:r(l,0),head:l==a.line?a:r(l)});e.setSelections(n,0)},t["Shift-Tab"]="indentLess",n[t.Esc="singleSelectionTop"]=function(e){var t=e.listSelections()[0];e.setSelection(t.anchor,t.head,{scroll:!1})},n[t[i+"L"]="selectLine"]=function(e){for(var t=e.listSelections(),n=[],o=0;o<t.length;o++){var i=t[o];n.push({anchor:r(i.from().line,0),head:r(i.to().line+1,0)})}e.setSelections(n)},t["Shift-"+i+"K"]="deleteLine",n[t[i+"Enter"]="insertLineAfter"]=function(e){s(e,!1)},n[t["Shift-"+i+"Enter"]="insertLineBefore"]=function(e){s(e,!0)},n[t[i+"D"]="selectNextOccurrence"]=function(t){var n=t.getCursor("from"),o=t.getCursor("to"),i=t.state.sublimeFindFullWord==t.doc.sel;if(0==e.cmpPos(n,o)){var a=c(t,n);if(!a.word)return;t.setSelection(a.from,a.to),i=!0}else{var l=t.getRange(n,o),s=i?new RegExp("\\b"+l+"\\b"):l,f=t.getSearchCursor(s,o);f.findNext()?t.addSelection(f.from(),f.to()):(f=t.getSearchCursor(s,r(t.firstLine(),0))).findNext()&&t.addSelection(f.from(),f.to())}i&&(t.state.sublimeFindFullWord=t.doc.sel)};var f="(){}[]";function u(e){var t=e.getCursor(),n=e.scanForBracket(t,-1);if(n)for(;;){var o=e.scanForBracket(t,1);if(!o)return;if(o.ch==f.charAt(f.indexOf(n.ch)+1))return e.setSelection(r(n.pos.line,n.pos.ch+1),o.pos,!1),!0;t=r(o.pos.line,o.pos.ch+1)}}n[t["Shift-"+i+"Space"]="selectScope"]=function(e){u(e)||e.execCommand("selectAll")},n[t["Shift-"+i+"M"]="selectBetweenBrackets"]=function(t){if(!u(t))return e.Pass},n[t[i+"M"]="goToBracket"]=function(t){t.extendSelectionsBy(function(n){var o=t.scanForBracket(n.head,1);if(o&&0!=e.cmpPos(o.pos,n.head))return o.pos;var i=t.scanForBracket(n.head,-1);return i&&r(i.pos.line,i.pos.ch+1)||n.head})};var h=o?"Cmd-Ctrl-":"Shift-Ctrl-";function d(e,t){for(var n,o=e.listSelections(),i=[],a=0;a<o.length;a++){var l=o[a];if(!l.empty()){for(var s=l.from().line,c=l.to().line;a<o.length-1&&o[a+1].from().line==c;)c=l[++a].to().line;i.push(s,c)}}i.length?n=!0:i.push(e.firstLine(),e.lastLine()),e.operation(function(){for(var o=[],a=0;a<i.length;a+=2){var l=i[a],s=i[a+1],c=r(l,0),f=r(s),u=e.getRange(c,f,!1);t?u.sort():u.sort(function(e,t){var n=e.toUpperCase(),r=t.toUpperCase();return n!=r&&(e=n,t=r),e<t?-1:e==t?0:1}),e.replaceRange(u,c,f),n&&o.push({anchor:c,head:f})}n&&e.setSelections(o,0)})}n[t[h+"Up"]="swapLineUp"]=function(e){for(var t=e.listSelections(),n=[],o=e.firstLine()-1,i=[],a=0;a<t.length;a++){var l=t[a],s=l.from().line-1,c=l.to().line;i.push({anchor:r(l.anchor.line-1,l.anchor.ch),head:r(l.head.line-1,l.head.ch)}),0!=l.to().ch||l.empty()||--c,s>o?n.push(s,c):n.length&&(n[n.length-1]=c),o=c}e.operation(function(){for(var t=0;t<n.length;t+=2){var o=n[t],a=n[t+1],l=e.getLine(o);e.replaceRange("",r(o,0),r(o+1,0),"+swapLine"),a>e.lastLine()?e.replaceRange("\n"+l,r(e.lastLine()),null,"+swapLine"):e.replaceRange(l+"\n",r(a,0),null,"+swapLine")}e.setSelections(i),e.scrollIntoView()})},n[t[h+"Down"]="swapLineDown"]=function(e){for(var t=e.listSelections(),n=[],o=e.lastLine()+1,i=t.length-1;i>=0;i--){var a=t[i],l=a.to().line+1,s=a.from().line;0!=a.to().ch||a.empty()||l--,l<o?n.push(l,s):n.length&&(n[n.length-1]=s),o=s}e.operation(function(){for(var t=n.length-2;t>=0;t-=2){var o=n[t],i=n[t+1],a=e.getLine(o);o==e.lastLine()?e.replaceRange("",r(o-1),r(o),"+swapLine"):e.replaceRange("",r(o,0),r(o+1,0),"+swapLine"),e.replaceRange(a+"\n",r(i,0),null,"+swapLine")}e.scrollIntoView()})},t[i+"/"]=function(e){e.toggleComment({indent:!0})},n[t[i+"J"]="joinLines"]=function(e){for(var t=e.listSelections(),n=[],o=0;o<t.length;o++){for(var i=t[o],a=i.from(),l=a.line,s=i.to().line;o<t.length-1&&t[o+1].from().line==s;)s=t[++o].to().line;n.push({start:l,end:s,anchor:!i.empty()&&a})}e.operation(function(){for(var t=0,o=[],i=0;i<n.length;i++){for(var a,l=n[i],s=l.anchor&&r(l.anchor.line-t,l.anchor.ch),c=l.start;c<=l.end;c++){var f=c-t;c==l.end&&(a=r(f,e.getLine(f).length+1)),f<e.lastLine()&&(e.replaceRange(" ",r(f),r(f+1,/^\s*/.exec(e.getLine(f+1))[0].length)),++t)}o.push({anchor:s||a,head:a})}e.setSelections(o,0)})},n[t["Shift-"+i+"D"]="duplicateLine"]=function(e){e.operation(function(){for(var t=e.listSelections().length,n=0;n<t;n++){var o=e.listSelections()[n];o.empty()?e.replaceRange(e.getLine(o.head.line)+"\n",r(o.head.line,0)):e.replaceRange(e.getRange(o.from(),o.to()),o.from())}e.scrollIntoView()})},t[i+"T"]="transposeChars",n[t.F9="sortLines"]=function(e){d(e,!0)},n[t[i+"F9"]="sortLinesInsensitive"]=function(e){d(e,!1)},n[t.F2="nextBookmark"]=function(e){var t=e.state.sublimeBookmarks;if(t)for(;t.length;){var n=t.shift(),r=n.find();if(r)return t.push(n),e.setSelection(r.from,r.to)}},n[t["Shift-F2"]="prevBookmark"]=function(e){var t=e.state.sublimeBookmarks;if(t)for(;t.length;){t.unshift(t.pop());var n=t[t.length-1].find();if(n)return e.setSelection(n.from,n.to);t.pop()}},n[t[i+"F2"]="toggleBookmark"]=function(e){for(var t=e.listSelections(),n=e.state.sublimeBookmarks||(e.state.sublimeBookmarks=[]),r=0;r<t.length;r++){for(var o=t[r].from(),i=t[r].to(),a=e.findMarks(o,i),l=0;l<a.length;l++)if(a[l].sublimeBookmark){a[l].clear();for(var s=0;s<n.length;s++)n[s]==a[l]&&n.splice(s--,1);break}l==a.length&&n.push(e.markText(o,i,{sublimeBookmark:!0,clearWhenEmpty:!1}))}},n[t["Shift-"+i+"F2"]="clearBookmarks"]=function(e){var t=e.state.sublimeBookmarks;if(t)for(var n=0;n<t.length;n++)t[n].clear();t.length=0},n[t["Alt-F2"]="selectBookmarks"]=function(e){var t=e.state.sublimeBookmarks,n=[];if(t)for(var r=0;r<t.length;r++){var o=t[r].find();o?n.push({anchor:o.from,head:o.to}):t.splice(r--,0)}n.length&&e.setSelections(n,0)},t["Alt-Q"]="wrapLines";var p=i+"K ";function m(t,n){t.operation(function(){for(var r=t.listSelections(),o=[],i=[],a=0;a<r.length;a++){(s=r[a]).empty()?(o.push(a),i.push("")):i.push(n(t.getRange(s.from(),s.to())))}t.replaceSelections(i,"around","case");var l;for(a=o.length-1;a>=0;a--){var s=r[o[a]];if(!(l&&e.cmpPos(s.head,l)>0)){var f=c(t,s.head);l=f.from,t.replaceRange(n(f.word),f.from,f.to)}}})}function g(t){var n=t.getCursor("from"),r=t.getCursor("to");if(0==e.cmpPos(n,r)){var o=c(t,n);if(!o.word)return;n=o.from,r=o.to}return{from:n,to:r,query:t.getRange(n,r),word:o}}function v(e,t){var n=g(e);if(n){var o=n.query,i=e.getSearchCursor(o,t?n.to:n.from);(t?i.findNext():i.findPrevious())?e.setSelection(i.from(),i.to()):(i=e.getSearchCursor(o,t?r(e.firstLine(),0):e.clipPos(r(e.lastLine()))),(t?i.findNext():i.findPrevious())?e.setSelection(i.from(),i.to()):n.word&&e.setSelection(n.from,n.to))}}t[p+i+"Backspace"]="delLineLeft",n[t.Backspace="smartBackspace"]=function(t){if(t.somethingSelected())return e.Pass;var n=t.getCursor(),o=t.getRange({line:n.line,ch:0},n),i=e.countColumn(o,null,t.getOption("tabSize")),a=t.getOption("indentUnit");if(o&&!/\S/.test(o)&&i%a==0){var l=new r(n.line,e.findColumn(o,i-a,a));return l.ch==n.ch?e.Pass:t.replaceRange("",l,n,"+delete")}return e.Pass},n[t[p+i+"K"]="delLineRight"]=function(e){e.operation(function(){for(var t=e.listSelections(),n=t.length-1;n>=0;n--)e.replaceRange("",t[n].anchor,r(t[n].to().line),"+delete");e.scrollIntoView()})},n[t[p+i+"U"]="upcaseAtCursor"]=function(e){m(e,function(e){return e.toUpperCase()})},n[t[p+i+"L"]="downcaseAtCursor"]=function(e){m(e,function(e){return e.toLowerCase()})},n[t[p+i+"Space"]="setSublimeMark"]=function(e){e.state.sublimeMark&&e.state.sublimeMark.clear(),e.state.sublimeMark=e.setBookmark(e.getCursor())},n[t[p+i+"A"]="selectToSublimeMark"]=function(e){var t=e.state.sublimeMark&&e.state.sublimeMark.find();t&&e.setSelection(e.getCursor(),t)},n[t[p+i+"W"]="deleteToSublimeMark"]=function(t){var n=t.state.sublimeMark&&t.state.sublimeMark.find();if(n){var r=t.getCursor(),o=n;if(e.cmpPos(r,o)>0){var i=o;o=r,r=i}t.state.sublimeKilled=t.getRange(r,o),t.replaceRange("",r,o)}},n[t[p+i+"X"]="swapWithSublimeMark"]=function(e){var t=e.state.sublimeMark&&e.state.sublimeMark.find();t&&(e.state.sublimeMark.clear(),e.state.sublimeMark=e.setBookmark(e.getCursor()),e.setCursor(t))},n[t[p+i+"Y"]="sublimeYank"]=function(e){null!=e.state.sublimeKilled&&e.replaceSelection(e.state.sublimeKilled,null,"paste")},t[p+i+"G"]="clearBookmarks",n[t[p+i+"C"]="showInCenter"]=function(e){var t=e.cursorCoords(null,"local");e.scrollTo(null,(t.top+t.bottom)/2-e.getScrollInfo().clientHeight/2)},n[t["Shift-Alt-Up"]="selectLinesUpward"]=function(e){e.operation(function(){for(var t=e.listSelections(),n=0;n<t.length;n++){var o=t[n];o.head.line>e.firstLine()&&e.addSelection(r(o.head.line-1,o.head.ch))}})},n[t["Shift-Alt-Down"]="selectLinesDownward"]=function(e){e.operation(function(){for(var t=e.listSelections(),n=0;n<t.length;n++){var o=t[n];o.head.line<e.lastLine()&&e.addSelection(r(o.head.line+1,o.head.ch))}})},n[t[i+"F3"]="findUnder"]=function(e){v(e,!0)},n[t["Shift-"+i+"F3"]="findUnderPrevious"]=function(e){v(e,!1)},n[t["Alt-F3"]="findAllUnder"]=function(e){var t=g(e);if(t){for(var n=e.getSearchCursor(t.query),r=[],o=-1;n.findNext();)r.push({anchor:n.from(),head:n.to()}),n.from().line<=t.from.line&&n.from().ch<=t.from.ch&&o++;e.setSelections(r,o)}},t["Shift-"+i+"["]="fold",t["Shift-"+i+"]"]="unfold",t[p+i+"0"]=t[p+i+"j"]="unfoldAll",t[i+"I"]="findIncremental",t["Shift-"+i+"I"]="findIncrementalReverse",t[i+"H"]="replace",t.F3="findNext",t["Shift-F3"]="findPrev",e.normalizeKeyMap(t)});