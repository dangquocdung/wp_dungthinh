!function(e,t){"use strict";window.wvt=window.wvt||{},wvt.edit={},t.Segment=t.Class.extend({segmentType:"segment",loaded:!1,defaults:{name:"",type:"default",active:!0,parent:"",priority:10},initialize:function(n,i){var a=this;a.id=n,a.params=_.extend({},a.defaults,a.params||{},i||{}),a.priority=new t.Value,a.priority.set(a.params.priority),this.fields=new t.Values({defaultConstructor:t.Fields}),a.deferred={embedded:new e.Deferred},a.embed(),a.setContainerHolder(),a.deferred.embedded.done(function(){a.attachEvent(),a.ready()}),a.loadState(),a.params.container.containerHolder.bind(a.params.container.id,function(e){e.loaded&&a.triggerLoaded()})},triggerLoaded:function(){this.loaded=!0,this.containerHolder.trigger(this.id,this)},setContainerHolder:function(){this.containerHolder=this.params.container.segments},populateFields:function(e){e=this.prepareField(e),this.setupField(this.id,e)},prepareField:function(e){var t=0;return _.each(e,function(n,i){e[i]=this.prepareFieldData(e[i],n,t++)}.bind(this)),wvt.helper.prioritySort(e)},setupField:function(e,n){var i=null;_.each(n,function(e){i=_.has(t.fieldConstructor,e.type)?t.fieldConstructor[e.type]:t.fieldConstructor.standart,this.fields.has(e.id)||this.fields.add(e.id,new i(e.id,e))}.bind(this))},attachEvent:function(){},ready:function(){},loadState:function(){var e=this.createFields();this.populateFields(e)},prepareFieldData:function(e){var t=this.params.container.params,n=t.values;return e.parent=this,e.parent.element=this.params.container.element.find(".wvt-edit-panorama"),e.fieldName=t.id+"["+e.fieldName+"]",e.value=n.hasOwnProperty(e.id)?n[e.id]:null,e},createFields:function(){return this.params.container.params.options},embed:function(){this.deferred.embedded.resolve()}}),t.SingleSegment=t.Segment.extend({}),t.MultiSegment=t.Segment.extend({createFields:function(){var e=this.params.container.params,t=this.params.index,n=e.default;this.params.initial?n=this.params.initial:e.values[t]&&(n=e.values[t]);var i,a=(i=e.options,JSON.parse(JSON.stringify(i)));for(var s in a)a.hasOwnProperty(s)&&(a[s].fieldName=e.id+"["+t+"]["+a[s].fieldName+"]",n.hasOwnProperty(s)?a[s].value=n[s]:a[s].value=null);return a},embed:function(){this.params.container.emptySection&&this.params.container.emptySection.remove(),this.sectionContent=e(this.renderSectionContent()),this.getParentContainer().find(".wvt-edit-panorama").append(this.sectionContent),this.deferred.embedded.resolve()},getParentContainer:function(){return this.params.container.element},attachEvent:function(){this.sectionContent.find(".wvt-section-header").on("click",this.activateSection.bind(this)),this.sectionContent.find(".tab-delete").on("click",this.removeSection.bind(this))},activateSection:function(){this.params.container.switchActiveSegment(this.id)},toggleSection:function(){e(this.sectionContent).find(".wvt-section-content").stop().slideToggle(null,function(){var t=e(this).parents(".wvt-section-item").position().top;wvt.helper.scrollToTopScrollbar(t)})},openSection:function(){e(this.sectionContent).find(".wvt-section-content").stop().slideDown()},collapseSection:function(){e(this.sectionContent).find(".wvt-section-content").stop().slideUp()},renderSection:function(){var e;return(e=wp.template("wvt-container-section"))?e(this.params):"<div></div>"},renderSectionContent:function(){var e;return(e=wp.template("wvt-container-section-content"))?e(this.params):"<div></div>"},prepareFieldData:function(e){return e.parent=this,e.parent.element=this.sectionContent.find(".wvt-section-content"),e},removeSection:function(e){e.preventDefault(),this.sectionContent.remove(),this.params.container.removeSegment(this.id,this.params.index),wvt.helper.removeSpotItem(this.id),wvt.helper.scrollToTopScrollbar()}}),t.segmentConstructor={single:t.SingleSegment,multi:t.MultiSegment},t.TabbedContainer=t.Class.extend({tabHeaderSelector:".wvt-option-header",tabBodySelector:".wvt-option-body",loaded:!1,defaults:{type:"single",title:"",active:!0,priority:10},initialize:function(e,n){this.id=e,this.params=_.extend({},this.defaults,this.params||{},n||{}),this.segments=new t.Values({defaultConstructor:t.Segment}),this.activeSegment=new t.Value,this.segmentEvent=new t.Eval,this.embeed(),this.setContainerHolder(),this.loadContainer()},embeed:function(){var t=this.params.active?"active":"";this.navigationElement=e(this.renderNavigationContent()).addClass(t),this.navigationHolder=e(this.tabHeaderSelector),this.navigationHolder.append(this.navigationElement),this.element=e(this.renderContent()).addClass(t),this.holder=e(this.tabBodySelector),this.holder.append(this.element).parents("#wvt-option-wrapper").addClass("form-loaded"),"multi"===this.params.type&&(this.params.values.length||this.renderEmptySection())},setContainerHolder:function(){this.containerHolder=t.optioncontainer},loadContainer:function(){this.bindClick(),this.populateSegments()},triggerFinish:function(){this.loaded=!0,this.containerHolder.trigger(this.id,this)},bindClick:function(){this.navigationElement.on("click",this.activateTab.bind(this))},collapseAllSection:function(){"multi"===this.params.type&&this.segments.each(function(e){e.collapseSection()})},activateTab:function(){this.navigationHolder.find("li").removeClass("active"),e(this.navigationElement).addClass("active"),this.holder.find(".wvt-option-content").removeClass("active"),e(this.element).addClass("active"),window.dispatchEvent(new Event("resize")),wvt.helper.scrollToTopScrollbar()},populateSegments:function(){if("single"===this.params.type){var e={"main-segment":{id:"main-segment",name:"Main Segment",type:"single"}};e=this.prepareSegment(e),this.setupSegment(this.id,e)}else for(var t in this.params.values){var n=this.createSegmentParam(t);n=this.prepareSegment(n),this.setupSegment(this.id,n)}},createMultiSegment:function(e){var t=this.getNextSegmentIndex(),n=this.createSegmentParam(t),i=n.segment.id;return e=jQuery.extend(this.params.default,e),(n=this.prepareSegment(n))[0].initial=e,this.setupSegment(this.id,n),this.segments(i).triggerLoaded(),i},createSegmentParam:function(e,t){var n=wvt.helper.segmentName(this.params.id,e);return e=parseInt(e),{segment:{id:n,name:this.params.title+" "+(e+1),type:this.params.type,index:e,initial:t}}},getNextSegmentIndex:function(){var e=0,t=!1;return this.segments.each(function(n){e=n.params.index,t=!0}),t||0!==e?++e:e},setupSegment:function(e,n){var i=null;_.each(n,function(e){i=_.has(t.segmentConstructor,e.type)?t.segmentConstructor[e.type]:t.segmentConstructor.normal,this.segments.has(e.id)||(this.segments.add(e.id,new i(e.id,e)),this.segmentEventTrigger("add",e.id))}.bind(this))},prepareSegment:function(e){return e=wvt.helper.prioritySort(e),_.each(e,function(t,n){"multi"===t.type?e[n]=this.prepareMultiSegmentData(e[n]):e[n]=this.prepareSegmentData(e[n])}.bind(this)),e},prepareSegmentData:function(e){return e.parent=this.id,e.container=this,e},prepareMultiSegmentData:function(e){return e.parent=this.id,e.container=this,e},renderNavigationContent:function(){var e;return(e=wp.template("wvt-container-tabbed"))?e(this.params):"<div></div>"},renderContent:function(){var e;return(e=wp.template("wvt-container-body"))?e(this.params):"<div></div>"},renderEmptySection:function(){this.emptySection=e(this.getEmptySection()),this.element.find(".wvt-edit-panorama").html(this.emptySection)},getEmptySection:function(){var e;return(e=wp.template("wvt-section-empty"))?e(this.params):"<div></div>"},switchActiveSegment:function(e){this.segments.each(function(t){t.id===e?t.toggleSection():t.collapseSection()}),this.activeSegment.set(e)},removeSegment:function(e,t){this.segmentEventTrigger("remove",e),this.segments.remove(e),this.params.values.splice(t,1),this.getAllSegments().length||this.renderEmptySection()},getAllSegments:function(){var e=[];return this.segments.each(function(t){e.push(t.id)}),e},segmentEventTrigger:function(e,t){this.segmentEvent.set({type:e,id:t})}}),t.optioncontainer=new t.Values({defaultConstructor:t.TabbedContainer}),wvt.edit.build=function(e,n,i){return _.each(n.tab,function(e){if(!t.optioncontainer.has(e.id)){var n=e;n.values=i[e.id];var a=new t.TabbedContainer(e.id,n);t.optioncontainer.add(e.id,a),t.optioncontainer(e.id).triggerFinish()}}),t.optioncontainer}}(jQuery,wp.customize);